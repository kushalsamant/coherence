# Database Migrations Guide

## Overview

Sketch-to-BIM uses **Alembic** for database schema version control. Migrations run **automatically** on application startup, so you don't need to manually run migration commands in most cases.

## How Auto-Migrations Work

When the application starts, it automatically:

1. Checks if `AUTO_RUN_MIGRATIONS` is enabled (default: `true`)
2. Runs `alembic upgrade head` to apply any pending migrations
3. Logs the migration status
4. Falls back to `init_db()` if migrations fail (for backward compatibility)

### Benefits

- ✅ **Zero manual steps**: Migrations run automatically on every deployment
- ✅ **Production safe**: Uses Alembic's versioned migrations with rollback capability
- ✅ **Flexible**: Can disable auto-migrations if needed
- ✅ **Developer friendly**: Clear workflow for creating new migrations

## Creating New Migrations

When you modify database models (in `backend/app/models.py`), you need to create a new migration:

### Step 1: Generate Migration

```bash
cd backend
alembic revision --autogenerate -m "Description of changes"
```

This creates a new migration file in `backend/alembic/versions/` with the changes detected from your models.

### Step 2: Review the Migration

**Always review the generated migration file** before applying it. Alembic's autogenerate can sometimes miss complex changes or generate incorrect SQL.

```bash
# View the generated migration
cat backend/alembic/versions/XXX_description_of_changes.py
```

### Step 3: Test Locally

```bash
# Apply the migration to your local database
alembic upgrade head
```

### Step 4: Commit and Deploy

1. Commit the migration file to git
2. Deploy to production
3. The migration will run automatically on startup

## Disabling Auto-Migrations

If you need to run migrations manually (e.g., for debugging or special cases), set:

```bash
AUTO_RUN_MIGRATIONS=false
```

When disabled, the app will use `init_db()` instead, which creates tables from models but doesn't track migration history.

**Note:** Manual migrations are not recommended for production. Use auto-migrations for safety and rollback capability.

## Migration Workflow for Developers

### Daily Development

1. **Modify models** in `backend/app/models.py`
2. **Generate migration**: `alembic revision --autogenerate -m "your description"`
3. **Review migration file** carefully
4. **Test locally**: `alembic upgrade head`
5. **Commit** migration file to git
6. **Deploy** - migrations run automatically

### Checking Migration Status

```bash
# Check current database revision
alembic current

# Check what migrations are pending
alembic heads

# View migration history
alembic history
```

### Rolling Back Migrations

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision_id>

# Rollback all migrations (⚠️ dangerous)
alembic downgrade base
```

**Warning:** Only rollback in development. Production rollbacks should be done carefully and may require data migration scripts.

## Troubleshooting

### Migration Fails on Startup

If migrations fail during startup:

1. Check application logs for the error message
2. The app will fall back to `init_db()` but this is not ideal
3. Fix the migration issue and redeploy

### "Can't locate revision identified by..."

This means the database has a migration revision that doesn't exist in your codebase. This can happen if:

- You're running an older version of the code against a newer database
- Migration files were deleted from the repository

**Solution:** Sync your codebase with the database state, or manually fix the `alembic_version` table.

### "Target database is not up to date"

The database is missing some migrations. This should be automatically fixed by auto-migrations, but if it persists:

```bash
# Manually run migrations
cd backend
alembic upgrade head
```

### Migration Conflicts

If multiple developers create migrations simultaneously:

1. Pull the latest code
2. Merge migration files if needed
3. Test locally: `alembic upgrade head`
4. Resolve any conflicts in migration files
5. Commit and deploy

## Best Practices

1. **Always review autogenerated migrations** - Alembic can miss complex changes
2. **Test migrations locally** before deploying
3. **Keep migrations small and focused** - one logical change per migration
4. **Never edit existing migration files** that have been deployed to production
5. **Use descriptive migration messages** - "Add user subscription fields" not "Update models"
6. **Backup production database** before running migrations manually
7. **Test rollback procedures** in development before production

## Migration File Structure

Migration files are located in `backend/alembic/versions/` and follow this pattern:

```python
"""Description of changes

Revision ID: abc123
Revises: def456
Create Date: 2024-11-17 10:30:00.123456
"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'abc123'
down_revision = 'def456'
branch_labels = None
depends_on = None

def upgrade():
    # Migration code here
    op.add_column('users', sa.Column('new_field', sa.String(), nullable=True))

def downgrade():
    # Rollback code here
    op.drop_column('users', 'new_field')
```

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `AUTO_RUN_MIGRATIONS` | `true` | Enable/disable automatic migrations on startup |
| `DATABASE_URL` | Required | PostgreSQL connection string |

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Migrations Guide](https://docs.sqlalchemy.org/en/20/core/metadata.html)
- [Database Models](../backend/app/models.py)

