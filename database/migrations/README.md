# Database Migrations

Alembic migration system for ASK and Sketch2BIM databases.

## Structure

- `ask/` - ASK database migrations
- `sketch2bim/` - Sketch2BIM database migrations

Each directory contains:
- `alembic.ini` - Alembic configuration
- `env.py` - Migration environment setup
- `script.py.mako` - Migration template
- `versions/` - Migration files (versioned schema changes)

## Quick Start

### Run Migrations

**ASK database**:
```bash
cd database/migrations/ask
alembic upgrade head
```

**Sketch2BIM database**:
```bash
cd database/migrations/sketch2bim
alembic upgrade head
```

### Create New Migration

**ASK database**:
```bash
cd database/migrations/ask
alembic revision --autogenerate -m "add new column"
```

**Sketch2BIM database**:
```bash
cd database/migrations/sketch2bim
alembic revision --autogenerate -m "add new column"
```

### Check Migration Status

```bash
cd database/migrations/[ask|sketch2bim]
alembic current        # Show current version
alembic history        # Show all migrations
alembic heads          # Show head (latest) version
```

### Rollback Migration

```bash
cd database/migrations/[ask|sketch2bim]
alembic downgrade -1           # Rollback one migration
alembic downgrade <revision>   # Rollback to specific version
```

## Environment Variables

Required for each database:
- `ASK_DATABASE_URL` - ASK database connection string
- `SKETCH2BIM_DATABASE_URL` - Sketch2BIM database connection string

Format:
```
postgresql://user:password@host:5432/database_name
```

## Auto-Run Migrations

Migrations run automatically on application startup via:
- ASK: `apps/platform-api/utils/ask/migrations.py`
- Sketch2BIM: `apps/platform-api/utils/sketch2bim/migrations.py`

To disable auto-run migrations, set:
```bash
AUTO_RUN_MIGRATIONS=false
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic may not detect all changes correctly
2. **Test migrations locally first** - Never run untested migrations in production
3. **Keep migrations small** - One logical change per migration
4. **Write descriptive messages** - Use clear migration names
5. **Test rollback** - Ensure downgrade() works correctly
6. **Backup before migrating** - Always have a database backup

## Common Operations

### Add a new column
```python
def upgrade():
    op.add_column('users', sa.Column('new_field', sa.String(), nullable=True))

def downgrade():
    op.drop_column('users', 'new_field')
```

### Modify existing column
```python
def upgrade():
    op.alter_column('users', 'email', 
                   existing_type=sa.String(),
                   type_=sa.String(length=255),
                   nullable=False)

def downgrade():
    op.alter_column('users', 'email',
                   existing_type=sa.String(length=255),
                   type_=sa.String(),
                   nullable=True)
```

### Create index
```python
def upgrade():
    op.create_index('ix_users_email', 'users', ['email'], unique=True)

def downgrade():
    op.drop_index('ix_users_email', table_name='users')
```

## Troubleshooting

### Migration conflicts
If you get "multiple heads" error:
```bash
alembic merge heads -m "merge migrations"
```

### Reset migrations (DANGEROUS - dev only)
```bash
# Drop alembic_version table
# Drop all tables
# Run: alembic upgrade head
```

### Check migration SQL without running
```bash
alembic upgrade head --sql > migration.sql
```

## References

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- See `../MIGRATION_SYSTEMS.md` for system overview
- See `../../docs/migrations/` for application-specific guides

